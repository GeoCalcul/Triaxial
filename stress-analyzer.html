<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stress Analysis Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            background: #fafafa;
        }
        .upload-btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .upload-btn:hover {
            background: #0056b3;
        }
        .plot-buttons {
            margin: 20px 0;
        }
        .plot-btn {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        .plot-btn.active {
            background: #007bff;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            margin: 20px 0;
        }
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .info-card {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .card-blue { background: #e3f2fd; border-color: #1976d2; }
        .card-red { background: #ffebee; border-color: #d32f2f; }
        .card-green { background: #e8f5e8; border-color: #388e3c; }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Stress Analysis Tool</h1>
        
        <div class="upload-area">
            <h3>Upload CSV File</h3>
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('csvFile').click()">
                üìÅ Choose CSV File
            </button>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                CSV should contain columns: sigma1, sigma2, sigma3 (or similar)
            </p>
            <button class="upload-btn" onclick="useSampleData()" style="background: #28a745; margin-left: 10px;">
                üìä Use Sample Data
            </button>
            <div id="uploadStatus"></div>
        </div>

        <div class="plot-buttons">
            <button class="plot-btn active" id="pqBtn" onclick="showPlot('pq')">p vs q Plot</button>
            <button class="plot-btn" id="dpdqBtn" onclick="showPlot('dpdq')">dp/dq vs p Plot</button>
        </div>

        <div class="chart-container">
            <canvas id="stressChart"></canvas>
        </div>

        <div class="info-cards">
            <div class="info-card card-blue">
                <h4>Mean Stress (p)</h4>
                <p>p = (œÉ‚ÇÅ + œÉ‚ÇÇ + œÉ‚ÇÉ) / 3</p>
                <small>Average of principal stresses</small>
            </div>
            <div class="info-card card-red">
                <h4>Deviatoric Stress (q)</h4>
                <p>q = ‚àö[¬Ω((œÉ‚ÇÅ-œÉ‚ÇÇ)¬≤ + (œÉ‚ÇÇ-œÉ‚ÇÉ)¬≤ + (œÉ‚ÇÉ-œÉ‚ÇÅ)¬≤)]</p>
                <small>Measure of shear stress</small>
            </div>
            <div class="info-card card-green">
                <h4>Derivative (dp/dq)</h4>
                <p>Finite difference approximation</p>
                <small>Rate of change of p with respect to q</small>
            </div>
        </div>

        <div style="margin-top: 20px; font-size: 12px; color: #666;">
            <p id="dataInfo">Data points: 0 | All stresses converted to kPa for readability</p>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentChart = null;
        let currentPlotType = 'pq';
        
        // Sample data
        const sampleData = [
            [-69365, 37446, -246000], [0, 112000, 58424], [154000, 123000, -83897],
            [0, 55932, 137000], [-54218, 84859, -22311], [0, 89543, 185000],
            [-24037, 108000, -11915], [0, 102000, 195000], [-5371.9, 117000, -6204],
            [0, 104000, 196000], [-2228, 118000, -3781], [0, 111000, 207000],
            [1771.2, 123000, -1428.8], [0, 107000, 206000], [-5636.6, 120000, -858.31],
            [0, 106000, 208000], [-8394.9, 120000, -725.42], [0, 109000, 210000],
            [-5082, 122000, -668.84], [0, 110000, 211000], [-3537.7, 122000, -451.96]
        ];

        function processStressData(stressData) {
            const processedData = stressData.map((row, index) => {
                const sigma1 = row[0] / 1000; // Convert to kPa
                const sigma2 = row[1] / 1000;
                const sigma3 = row[2] / 1000;
                
                const p = (sigma1 + sigma2 + sigma3) / 3;
                const q = Math.sqrt(0.5 * ((sigma1 - sigma2)**2 + (sigma2 - sigma3)**2 + (sigma3 - sigma1)**2));
                
                return { p, q, index, sigma1, sigma2, sigma3 };
            });

            // Calculate dp/dq
            return processedData.map((point, i) => {
                let dpdq = 0;
                if (i > 0 && i < processedData.length - 1) {
                    const dp = processedData[i + 1].p - processedData[i - 1].p;
                    const dq = processedData[i + 1].q - processedData[i - 1].q;
                    dpdq = dq !== 0 ? dp / dq : 0;
                } else if (i === 0 && processedData.length > 1) {
                    const dp = processedData[i + 1].p - processedData[i].p;
                    const dq = processedData[i + 1].q - processedData[i].q;
                    dpdq = dq !== 0 ? dp / dq : 0;
                }
                
                return { ...point, dpdq: Math.abs(dpdq) > 100 ? 0 : dpdq };
            });
        }

        function createChart(data, type) {
            const ctx = document.getElementById('stressChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }

            const chartData = {
                datasets: [{
                    label: type === 'pq' ? 'q vs p' : 'dp/dq vs p',
                    data: data.map(point => ({
                        x: point.p,
                        y: type === 'pq' ? point.q : point.dpdq
                    })),
                    borderColor: type === 'pq' ? '#2563eb' : '#dc2626',
                    backgroundColor: type === 'pq' ? '#2563eb' : '#dc2626',
                    fill: false,
                    tension: 0.1
                }]
            };

            currentChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'p (Mean Stress) [kPa]'
                            }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: type === 'pq' ? 'q (Deviatoric Stress) [kPa]' : 'dp/dq'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Point ${context[0].parsed.x}`;
                                },
                                label: function(context) {
                                    const point = data[context.dataIndex];
                                    if (type === 'pq') {
                                        return [
                                            `p: ${point.p.toFixed(2)} kPa`,
                                            `q: ${point.q.toFixed(2)} kPa`
                                        ];
                                    } else {
                                        return [
                                            `p: ${point.p.toFixed(2)} kPa`,
                                            `dp/dq: ${point.dpdq.toFixed(4)}`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function showPlot(type) {
            currentPlotType = type;
            document.getElementById('pqBtn').classList.toggle('active', type === 'pq');
            document.getElementById('dpdqBtn').classList.toggle('active', type === 'dpdq');
            createChart(currentData, type);
        }

        function useSampleData() {
            currentData = processStressData(sampleData);
            createChart(currentData, currentPlotType);
            document.getElementById('dataInfo').textContent = 
                `Data points: ${currentData.length} | All stresses converted to kPa for readability | Data source: Sample data`;
            showStatus('‚úì Sample data loaded', 'success');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // File upload handler
        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showStatus('Please upload a CSV file', 'error');
                return;
            }

            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    try {
                        const data = results.data.filter(row => Object.values(row).some(val => val.trim()));
                        
                        // Find stress columns
                        const headers = Object.keys(data[0] || {});
                        const findColumn = (patterns) => {
                            for (const pattern of patterns) {
                                const found = headers.find(h => 
                                    h.toLowerCase().includes(pattern.toLowerCase())
                                );
                                if (found) return found;
                            }
                            return null;
                        };

                        const sigma1Col = findColumn(['sigma1', 'principle_stress:0', 'principal_stress_1', 's1']);
                        const sigma2Col = findColumn(['sigma2', 'principle_stress:1', 'principal_stress_2', 's2']);
                        const sigma3Col = findColumn(['sigma3', 'principle_stress:2', 'principal_stress_3', 's3']);

                        if (!sigma1Col || !sigma2Col || !sigma3Col) {
                            showStatus('‚ö†Ô∏è Could not find sigma1, sigma2, sigma3 columns', 'warning');
                            return;
                        }

                        const stressData = data.map(row => [
                            parseFloat(row[sigma1Col]) || 0,
                            parseFloat(row[sigma2Col]) || 0,
                            parseFloat(row[sigma3Col]) || 0
                        ]);

                        currentData = processStressData(stressData);
                        createChart(currentData, currentPlotType);
                        document.getElementById('dataInfo').textContent = 
                            `Data points: ${currentData.length} | All stresses converted to kPa for readability | Data source: ${file.name}`;
                        showStatus(`‚úì Loaded ${file.name} successfully`, 'success');
                        
                    } catch (error) {
                        showStatus('Error processing CSV file', 'error');
                        console.error('CSV processing error:', error);
                    }
                },
                error: function(error) {
                    showStatus('Error reading CSV file', 'error');
                    console.error('Papa Parse error:', error);
                }
            });
        });

        // Initialize with sample data
        window.addEventListener('load', function() {
            useSampleData();
        });
    </script>
</body>
</html>
